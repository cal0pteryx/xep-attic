<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>XEP-0289: Federated MUC for Constrained Environments</title><style type="text/css">
/* don't mind this hack */
nav#toc h2:before {
display: none;
content: "XEP-0289";
}
        </style><link rel="stylesheet" type="text/css" href="xmpp.css"><link href="prettify.css" type="text/css" rel="stylesheet"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="prettify.js"></script><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0"><meta name="DC.Title" content="Federated MUC for Constrained Environments"><meta name="DC.Creator" content="Kevin Smith"><meta name="DC.Description" content="This document provides a protocol for federating MUC rooms together in order to reduce the effects of constrained network (e.g. unreliability, severely limited bandwidth) on the room occupants."><meta name="DC.Publisher" content="XMPP Standards Foundation"><meta name="DC.Contributor" content="XMPP Extensions Editor"><meta name="DC.Date" content="2021-03-04"><meta name="DC.Type" content="XMPP Extension Protocol"><meta name="DC.Format" content="XHTML"><meta name="DC.Identifier" content="XEP-0289"><meta name="DC.Language" content="en"><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright © 1999 – 2020 by the XMPP Standards Foundation (XSF)."></head><body onload="prettyPrint()"><h1>XEP-0289: Federated MUC for Constrained Environments</h1><div class="docmeta-wrap"><dl id="docmeta" class="compact"><dt>Abstract</dt><dd>This document provides a protocol for federating MUC rooms together in order to reduce the effects of constrained network (e.g. unreliability, severely limited bandwidth) on the room occupants.</dd><dt>Author</dt><dd>Kevin Smith</dd><dt>Copyright</dt><dd>© 1999 – 2020 XMPP Standards Foundation. <a href="#appendix-legal">SEE LEGAL NOTICES</a>.</dd><dt>Status</dt><dd><p>Deferred</p><div id="status-notice" class="deferred standards track">WARNING: This document has been automatically Deferred after 12 months of inactivity in its previous Experimental state. Implementation of the protocol described herein is not recommended for production systems. However, exploratory implementations are encouraged to resume the standards process.</div></dd><dt>Type</dt><dd>Standards Track</dd><dt>Version</dt><dd>0.2.1 (2021-03-04)</dd></dl><div class="timeline-wrap"><div class="timeline-head">Document Lifecycle</div><ol class="timeline"><li>Experimental</li><li class="current inserted">Deferred</li><li>Proposed</li><li>Draft</li><li>Final</li></ol></div></div><nav id="toc"><a href="#top"><h2>Table of Contents</h2></a><ol class="toc"><li><a href="#intro">Introduction</a><ol><li><a href="#terminology">Terminology</a></li></ol></li><li><a href="#reqs">Requirements</a></li><li><a href="#addressing">Addressing</a></li><li><a href="#actors">Actors</a></li><li><a href="#usecases">Use Cases</a><ol><li><a href="#startup">Initial Federation</a></li><li><a href="#messages">Sending messages</a></li><li><a href="#activity">Subsequent activity</a></li><li><a href="#part">Leaving a room</a></li><li><a href="#admin">Administration</a></li><li><a href="#pm">Private Messages</a></li></ol></li><li><a href="#rules">Business Rules</a></li><li><a href="#security">Security Considerations</a></li><li><a href="#tbd">TBD</a></li><li><a href="#iana">IANA Considerations</a></li><li><a href="#registrar">XMPP Registrar Considerations</a></li><li><a href="#schema">XML Schema</a></li></ol><h6><a href="#appendices">Appendices</a></h6><ol class="toc-appendices"><li><a href="#appendix-docinfo">Document Information</a></li><li><a href="#appendix-authorinfo">Author Information</a></li><li><a href="#appendix-legal">Legal Notices</a></li><li><a href="#appendix-xmpp">Relation to XMPP</a></li><li><a href="#appendix-discuss">Discussion Venue</a></li><li><a href="#appendix-conformance">Requirements Conformance</a></li><li><a href="#appendix-notes">Notes</a></li><li><a href="#appendix-revs">Revision History</a></li></ol></nav><h2 id="intro">1.
       Introduction<a class="anchor-link" href="#intro"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">MUC's design generally assumes a highly reliable network providing plenty of bandwidth, and it functions well in Internet settings. It is sometimes the case that server to server traffic is heavily constrained, with typical problems for constrained links being high latency, tiny amounts of available bandwidth and unreliability (including, potentially, long-term failure of S2S links). This document provides methods for allowing experiences close to those of standard MUC use while operating across such constrained links by allowing rooms to federate with remote counterparts and for users to connect to the federated MUC node nearest to them on the network for a given FMUC room. It requires no setup in advance, and needs no bandwidth for remote rooms without local occupants. The premise is that a proxy room joins another room and receives stanzas from the MUC just as another occupant would; this is analogous to the client to server model, whereby a client would connect to their local server and the server deals with connections elsewhere - the client joins a local room and the room deals with connections to other federated rooms.</p>

  <div class="indent"><h3 id="terminology">1.1 Terminology<a class="anchor-link" href="#terminology"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">As MUCs are generally self-contained entities with a single address, federating them requires the introduction of some new terminology:</p>
    <ul class="" style="">
      <li class="" style="">FMUC set - the union of all MUC rooms that federate together</li>
      <li class="" style="">FMUC node - a single MUC room that is a member of an FMUC set (abbreviated to "node")</li>
      <li class="" style="">FMUC room - a room represented by an FMUC set</li>
      <li class="" style="">Primary-Primary mode - two FMUC nodes operating such that both will continue to work when a network fails between them. This mode has the properties of reduced network traffic and of not having a guarantee of consistent message ordering between nodes</li>
      <li class="" style="">Primary-Replica mode - two FMUC nodes operating where one, the primary, will continue working during a network outage while the replica will cease to work while it cannot communicate with the primary. This mode has increased network traffic and a consistent message delivery order across both nodes.</li>
      <li class="" style="">Joining FMUC node - a node that initiates an FMUC connection to another node (abbreviated to "joining node").</li>
      <li class="" style="">Joined FMUC node - a node that accepts an FMUC connection from another node (abbreviated to "joined node"). Note that when nodes are connected in a tree-like structure a node in one of the middle layers will be both a joining node in the context of its connection to the room above it and also a joined node in the context of those nodes below that join to it.</li>
    </ul>
    <p class="" style="">For illustration: if room1@rooms.server1.lit and room2@rooms.server2.lit federate with each other, then room1@rooms.server1.lit is an FMUC node, as is room2@rooms.server2.lit. Both nodes are in the FMUC set (along with any other node rooms that mutually federate) while the conceptual single room created by joining the FMUC set together is the FMUC room (and this FMUC room does not have a single definitive identifier).</p>
  </div>
<h2 id="reqs">2.
       Requirements<a class="anchor-link" href="#reqs"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <ul class="" style="">
  <li class="" style="">If appropriately configured, avoid bandwidth use that isn't strictly necessary for message exchange.</li>
  <li class="" style="">Allow conversation in a federated MUC to continue when one of the federated nodes is unavailable (e.g. due to network failure preventing S2S links forming), such that the nodes operate in a 'peer to peer' or 'multi-primary' mode.</li>
  <li class="" style="">If configured, allow a primary/replica configuration such that a disconnected node is no longer usable for local chat</li>
  <li class="" style=""><em>Acceptable compromise</em> When operating in multi-primary mode the message ordering may not be consistent between FMUC nodes.</li>
  </ul>
<h2 id="addressing">3.
       Addressing<a class="anchor-link" href="#addressing"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">In Federated MUC an FMUC room does not have a single logical address; when joining the FMUC room a user's client can join any of the nodes in the FMUC set for that room, and all addressing will appear to that client as if this was the single canonical representation of the room's address - while other users in the room may see different addresses dependent upon the node they joined.</p>
  <p class="" style="">It is possible, although not required, for an implementation and deployment to use <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0106.html">JID Escaping (XEP-0106)</a></span>  [<a href="#nt-idm79">1</a>] to make naming schemes easy to manage, but this is a matter of deployment policy and not of the protocol defined herein.</p>
<h2 id="actors">4.
       Actors<a class="anchor-link" href="#actors"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">The following JIDs are used in this document.</p>
  <ul class="" style="">
    <li class="" style="">wonderland.lit - service</li>
    <li class="" style="">rooms.wonderland.lit - MUC service on wonderland.lit.</li>
    <li class="" style="">alice@wonderland.lit - User on wonderland.lit</li>
    <li class="" style="">hatter@wonderland.lit - User on wonderland.lit</li>
    <li class="" style="">rabbithole@rooms.wonderland.lit - MUC room / FMUC node.</li>
    <li class="" style="">denmark.lit - service, likely connected to wonderland.lit over constrained link</li>
    <li class="" style="">talk.denmark.lit - MUC service on denmark.lit.</li>
    <li class="" style="">hamlet@denmark.lit - User on denmark.lit</li>
    <li class="" style="">ophelia@denmark.lit - User on denmark.lit</li>
    <li class="" style="">elsinore@talk.denmark.lit - MUC room / FMUC node.</li>
  </ul>
<h2 id="usecases">5.
       Use Cases<a class="anchor-link" href="#usecases"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><h3 id="startup">5.1 Initial Federation<a class="anchor-link" href="#startup"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">Here hamlet@denmark.lit is going to join the (currently empty) elsinor@talk.denmark.lit room. This room is configured as an FMUC node, federating with the rabbithole@rooms.wonderland.lit node, which current has one occupant - alice@wonderland.lit. The method of configuration that elsinor should federate with rabbithole is considered out of scope for this document - it is suggested that it be including in the standard MUC room configuration form. Note that this configuration only needs to be one way (that is: there is no protocol reason why rabbithole needs to know that elsinor will be federating with it in advance) - this allows for the ad-hoc addition of additional nodes to the FMUC room.</p>
        <p class="" style="">First hamlet@denmark.lit issues a normal MUC join request to elsinor@talk.denmark.lit</p>

<figure class="code-example" id="example-1"><figcaption><strong>Example 1.</strong> User joins FMUC node<a class="anchor-link" href="#example-1"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from='hamlet@denmark.lit/priam-ubuntu-vm' to="elsinore@talk.denmark.lit/Hamlet"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc"/&gt;
&lt;/presence&gt;
</pre></figure>

<p class="" style="">Elsinor then attempts to join with the FMUC node rabbithole@rooms.wonderland.lit.</p>

<figure class="code-example" id="example-2"><figcaption><strong>Example 2.</strong> FMUC Node begins initiates federation<a class="anchor-link" href="#example-2"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from='elsinore@talk.denmark.lit/Hamlet' to='rabbithole@rooms.wonderland.lit/Hamlet'&gt;
    &lt;fmuc xmlns='http://isode.com/protocol/fmuc' from='hamlet@denmark.lit/priam-ubuntu-vm'/&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc"/&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
      &lt;item affiliation="none" role="participant" jid="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;
</pre></figure>

<p class="" style="">Now rabbithole may reject the join, if elsinor is not permitted to federate. To do this it sends a 'presence' reply from its bare JID to the bare JID of the joining node with an 'fmuc' payload containing a 'reject' element and MAY include a human-readable explanation as the text content of the 'reject' element.</p>

<figure class="code-example" id="example-3"><figcaption><strong>Example 3.</strong> Second FMUC Node rejects federation<a class="anchor-link" href="#example-3"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from="rabbithole@rooms.wonderland.lit" to="elsinore@talk.denmark.lit"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc"&gt;
    &lt;reject&gt;No cross-domain federation.&lt;/reject&gt;
  &lt;/fmuc&gt;
&lt;/presence&gt;
</pre></figure>

<p class="" style="">Or it may accept the federation request and reply with the list of current occupants and message context in the same order as specified in XEP-0045. Note that the fmuc element is always added containing the JID of the user (possibly passed down from other FMUC nodes, or indeed from the joining node for the presence of the user used for the initial join), while the XEP-0045 rules apply for whether to include the jid in the muc#user element.</p>
<p class="" style="">As part of the initial join of one node to another, the node being joined will send the current topic to the node doing the joining. The node receiving this (the joining node) SHOULD replace its own subject with the received one.</p>
<p class="" style="">The joining node may add an element to the initial presence to the node being joined limiting the amount of history to be sent in the normal manner, as in XEP-0045.</p>


<figure class="code-example" id="example-4"><figcaption><strong>Example 4.</strong> Second FMUC Node accepts federation and sends occupants and history<a class="anchor-link" href="#example-4"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from="rabbithole@rooms.wonderland.lit/Alice" to="elsinore@talk.denmark.lit"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="alice@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="owner" role="moderator" jid="alice@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="rabbithole@rooms.wonderland.lit/Hamlet" to="elsinore@talk.denmark.lit"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="none" role="participant" jid="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;message from="rabbithole@rooms.wonderland.lit/Alice" to="elsinore@talk.denmark.lit" type="groupchat"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="alice@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;body&gt;This is an old message from the history&lt;/body&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120419T16:00:44"/&gt;
&lt;/message&gt;

&lt;message from="rabbithole@rooms.wonderland.lit/Hatter" to="elsinore@talk.denmark.lit" type="groupchat"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;body&gt;This is another old message from the history&lt;/body&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120501T10:03:24"/&gt;
&lt;/message&gt;

&lt;message from="rabbithole@rooms.wonderland.lit/Alice" to="elsinore@talk.denmark.lit" type="groupchat"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;subject&gt;This is the subject&lt;/subject&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120528T14:39:34"/&gt;
&lt;/message&gt;
</pre></figure>

<p class="" style="">Upon receiving the occupants, history and subject from the other node the joining FMUC node will process these in the normal way, treating the received presence as joins, adding the history to the room's history (re-ordering by delay?) and changing the subject. The joining FMUC node MUST NOT send the traffic generated by these data back to the joined room, but only deliver them to local participants (and in the case of chained FMUC nodes, any nodes joined to it). It also MUST NOT pass the fmuc payloads through to local clients.</p>

<figure class="code-example" id="example-5"><figcaption><strong>Example 5.</strong> First FMUC Node relays the state to the joined client<a class="anchor-link" href="#example-5"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from="elsinore@talk.denmark.lit/Alice" to="hamlet@denmark.lit/priam-ubuntu-vm"&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="owner" role="moderator" jid="alice@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="elsinore@talk.denmark.lit/Hamlet" to="hamlet@denmark.lit/priam-ubuntu-vm"&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="none" role="participant" jid="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;message from="elsinore@talk.denmark.lit/Alice" to="hamlet@denmark.lit/priam-ubuntu-vm" type="groupchat"&gt;
  &lt;body&gt;This is an old message from the history&lt;/body&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120419T16:00:44"/&gt;
&lt;/message&gt;

&lt;message from="elsinore@talk.denmark.lit/Hatter" to="hamlet@denmark.lit/priam-ubuntu-vm" type="groupchat"&gt;
  &lt;body&gt;This is another old message from the history&lt;/body&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120501T10:03:24"/&gt;
&lt;/message&gt;

&lt;message from="elsinore@talk.denmark.lit/Hatter" to="hamlet@denmark.lit/priam-ubuntu-vm" type="groupchat"&gt;
  &lt;subject&gt;This is the subject&lt;/subject&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120528T14:39:34"/&gt;
&lt;/message&gt;
</pre></figure>
</div>
<div class="indent"><h3 id="messages">5.2 Sending messages<a class="anchor-link" href="#messages"><abbr title="Link to this point in the document">¶</abbr></a></h3>
<p class="" style="">Then hamlet@denmark.lit sends a message to the FMUC room, which is sent from the elsinor node to the rabbithole node and then broadcast to the local occupants of each room according to the standard XEP-0045 rules (rabbithole distributes to alice, elsinor distributes to hamlet). This example is for primary-primary mode, so rabbithole does not echo the message back to elsinore and elsinore does not need to wait for receipt of this stanza from rabbithole before distributing the stanza locally.</p>

<figure class="code-example" id="example-6"><figcaption><strong>Example 6.</strong> User on FMUC Node sends a message<a class="anchor-link" href="#example-6"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;message from='hamlet@denmark.lit/priam-ubuntu-vm' to='elsinore@talk.denmark.lit' type='groupchat'&gt;
    &lt;body&gt;Hi Alice&lt;/body&gt;
&lt;/message&gt;

&lt;message from='elsinore@talk.denmark.lit/Hamlet' to='hamlet@denmark.lit/priam-ubuntu-vm' type='groupchat'&gt;
    &lt;body&gt;Hi Alice&lt;/body&gt;
&lt;/message&gt;

&lt;message from='elsinore@talk.denmark.lit/Hamlet' to='rabbithole@rooms.wonderland.lit' type='groupchat'&gt;
    &lt;body&gt;Hi Alice&lt;/body&gt;
    &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
&lt;/message&gt;

&lt;message from='rabbithole@rooms.wonderland.lit/Hamlet' to='alice@wonderland.lit/priam-ubuntu-vm' type='groupchat'&gt;
    &lt;body&gt;Hi Alice&lt;/body&gt;
&lt;/message&gt;

</pre></figure>

<p class="" style="">alice@wonderland.lit then replies to this message, causing a similar distribution.</p>

<figure class="code-example" id="example-7"><figcaption><strong>Example 7.</strong> User on other FMUC Node replies to message<a class="anchor-link" href="#example-7"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;message from='alice@wonderland.lit/priam-ubuntu-vm' to='rabbithole@rooms.wonderland.lit' type='groupchat'&gt;
    &lt;body&gt;Hi Hamlet&lt;/body&gt;
&lt;/message&gt;

&lt;message from='rabbithole@rooms.wonderland.lit/Alice' to='alice@wonderland.lit/priam-ubuntu-vm' type='groupchat'&gt;
    &lt;body&gt;Hi Hamlet&lt;/body&gt;
&lt;/message&gt;

&lt;message from='rabbithole@rooms.wonderland.lit/Alice' to='elsinore@talk.denmark.lit' type='groupchat'&gt;
    &lt;body&gt;Hi Hamlet&lt;/body&gt;
    &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="alice@wonderland.lit/priam-ubuntu-vm"/&gt;
&lt;/message&gt;

&lt;message from='elsinore@talk.denmark.lit/Hamlet' to='hamlet@denmark.lit/priam-ubuntu-vm' type='groupchat'&gt;
    &lt;body&gt;Hi Hamlet&lt;/body&gt;
&lt;/message&gt;

</pre></figure>

</div>
<div class="indent"><h3 id="activity">5.3 Subsequent activity<a class="anchor-link" href="#activity"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">Another user joining or parting a room will be "fanned-out" in much the same way - the node to which they're joined will send out their presence to all the locally joined users and to the other FMUC nodes to which it's connected, and those nodes will then do the same - noting that in primary-primary mode they won't distribute the stanza back to the node from which they received it.</p>
<figure class="code-example" id="example-8"><figcaption><strong>Example 8.</strong> Additional user joins FMUC room<a class="anchor-link" href="#example-8"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from="hatter@wonderland.lit/priam-ubuntu-vm" to="rabbithole@rooms.wonderland.lit/Hatter"&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc"/&gt;
&lt;/presence&gt;

&lt;presence from="rabbithole@rooms.wonderland.lit/Hatter" to="alice@wonderland.lit/priam-ubuntu-vm"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
        &lt;item affiliation="none" role="participant" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="rabbithole@rooms.wonderland.lit/Alice" to="hatter@wonderland.lit/priam-ubuntu-vm"&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="owner" role="moderator" jid="alice@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="rabbithole@rooms.wonderland.lit/Hamlet" to="hatter@wonderland.lit/priam-ubuntu-vm"&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="none" role="participant" jid="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="rabbithole@rooms.wonderland.lit/Hatter" to="hatter@wonderland.lit/priam-ubuntu-vm"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
        &lt;item affiliation="none" role="participant" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
        &lt;status code="110"/&gt;
        &lt;status code="100"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;

&lt;!--Message history sent to hatter elided for brevity --&gt;
&lt;message from="rabbithole@rooms.wonderland.lit/Hatter" to="hatter@wonderland.lit/priam-ubuntu-vm" type="groupchat"&gt;
  &lt;subject&gt;This is the subject&lt;/subject&gt;
  &lt;x xmlns="urn:xmpp:delay" from="rabbithole@rooms.wonderland.lit" stamp="20120528T14:39:34"/&gt;
&lt;/message&gt;

&lt;presence from='rabbithole@rooms.wonderland.lit/Hatter' to='elsinore@talk.denmark.lit/Hatter'&gt;
  &lt;fmuc xmlns='http://isode.com/protocol/fmuc' from='hatter@wonderland.lit/priam-ubuntu-vm'/&gt;
  &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
    &lt;item affiliation="none" role="participant" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
  &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="elsinore@talk.denmark.lit/Hatter" to="hamlet@denmark.lit/priam-ubuntu-vm"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
        &lt;item affiliation="none" role="participant" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;

</pre></figure>

</div>
<div class="indent"><h3 id="part">5.4 Leaving a room<a class="anchor-link" href="#part"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">When a user leaves a room the presence is distributed in the same way.</p>
<figure class="code-example" id="example-9"><figcaption><strong>Example 9.</strong> User leaves FMUC node<a class="anchor-link" href="#example-9"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from="hatter@wonderland.lit/priam-ubuntu-vm" type="unavailable" to="rabbithole@rooms.wonderland.lit/Hatter"/&gt;


&lt;presence from="rabbithole@rooms.wonderland.lit/Hatter" type="unavailable" to="hatter@wonderland.lit/priam-ubuntu-vm"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
        &lt;item affiliation="none" role="none" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
        &lt;status code="110"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from="rabbithole@rooms.wonderland.lit/Hatter" type="unavailable" to="alice@wonderland.lit/priam-ubuntu-vm"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
        &lt;item affiliation="none" role="none" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;

&lt;presence from='rabbithole@rooms.wonderland.lit/Hatter' to='elsinore@talk.denmark.lit/Hamlet' type='unavailable'&gt;
  &lt;x xmlns='http://jabber.org/protocol/muc#user'&gt;
    &lt;item affiliation='none' role='none' jid='hatter@wonderland.lit/priam-ubuntu-vm'/&gt;
  &lt;/x&gt;
  &lt;fmuc xmlns='http://isode.com/protocol/fmuc' from='hatter@wonderland.lit/priam-ubuntu-vm'/&gt;
&lt;/presence&gt;

&lt;presence from="elsinore@talk.denmark.lit/Hatter" type="unavailable" to="hamlet@denmark.lit/priam-ubuntu-vm"&gt;
    &lt;x xmlns="http://jabber.org/protocol/muc#user"&gt;
        &lt;item affiliation="none" role="none" jid="hatter@wonderland.lit/priam-ubuntu-vm"/&gt;
    &lt;/x&gt;
&lt;/presence&gt;

</pre></figure>
    <p class="" style="">When the last user on a joining FMUC node leaves the room the joining node has no more users in the joined node and the joining node will be considered to have left the FMUC set. Further activity in the FMUC set not be sent to the joining node (unless it subsequently rejoins the set).</p>
    <p class="" style="">The joined room confirms that the joining room has left the set by sending a presence stanza from the bare JID of the joined room to the bare JID of the joining room with an FMUC payload containing an element 'left'.</p>
<figure class="code-example" id="example-10"><figcaption><strong>Example 10.</strong> Joined FMUC node alerts the joining node that it is no longer in the FMUC set<a class="anchor-link" href="#example-10"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;presence from="rabbithole@rooms.wonderland.lit" to="elsinore@talk.denmark.lit"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc"&gt;
    &lt;left/&gt;
  &lt;/fmuc&gt;
&lt;/presence&gt;
</pre></figure>
</div>


<div class="indent"><h3 id="admin">5.5 Administration<a class="anchor-link" href="#admin"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">When an FMUC node receives notice that one of their users has been kicked by a moderator on another node it SHOULD kick the user and fan-out the consequent presence stanzas to other nodes.</p>
    <p class="" style="">Role change should be distributed across nodes and fanned out to users, but only cosmetically (e.g. an owner on another node cannot effect changes to the affiliation lists on this node).</p>
    
</div>


<div class="indent"><h3 id="pm">5.6 Private Messages<a class="anchor-link" href="#pm"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">When sending a private message to an occupant of another node, each node that receives it is responsible for routing it to the appropriate node (or the occupant, if local).</p>
    <figure class="code-example" id="example-11"><figcaption><strong>Example 11.</strong> User sends private message to occupant of other node<a class="anchor-link" href="#example-11"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;message to="elsinore@talk.denmark.lit/Alice" from="hamlet@denmark.lit/priam-ubuntu-vim" type="chat"&gt;
  &lt;body&gt;Hi, I want to say something in private&lt;/body&gt;
&lt;/message&gt;

&lt;message to="rabbithole@rooms.wonderland.lit/Alice" from="elsinore@talk.denmark.lit/Hamlet" type="chat"&gt;
  &lt;fmuc xmlns="http://isode.com/protocol/fmuc" from="hamlet@denmark.lit/priam-ubuntu-vm"/&gt;
  &lt;body&gt;Hi, I want to say something in private&lt;/body&gt;
&lt;/message&gt;

&lt;message to="alice@wonderland.lit/priam-ubuntu-vim" from="rabbithole@rooms.wonderland.lit/Hamlet" type="chat"&gt;
  &lt;body&gt;Hi, I want to say something in private&lt;/body&gt;
&lt;/message&gt;

</pre></figure>
</div>

<h2 id="rules">6.
       Business Rules<a class="anchor-link" href="#rules"><abbr title="Link to this point in the document">¶</abbr></a></h2>
<h2 id="security">7.
       Security Considerations<a class="anchor-link" href="#security"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">This allows an FMUC node to proxy for another JID, so should only be deployed in scenarios where either the FMUC nodes are trusted, or it is known that the users of an FMUC node are in the same security domain as the FMUC node itself.</p>
<h2 id="tbd">8.
       TBD<a class="anchor-link" href="#tbd"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">How to get the join-target to tell the joining room how much history to send during a resync.</p>
  <p class="" style="">How to perform a resync (Part and then full rejoin)</p>
  <p class="" style="">Illustrate primary-replica mode - this is simply that the sending room waits for the echo back from the room to which it's joined before distributing messages locally.</p>
  <p class="" style="">Describe collisions. Send fmuc payload saying there's a collision back to the node, Node with local user can then send an error message about the collision and kick them.</p>
  <h2 id="iana">9.
       IANA Considerations<a class="anchor-link" href="#iana"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">None.</p>
<h2 id="registrar">10.
       XMPP Registrar Considerations<a class="anchor-link" href="#registrar"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">Needs a namespace.</p>
<h2 id="schema">11.
       XML Schema<a class="anchor-link" href="#schema"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">When advanced.</p>
<hr><a name="appendices"></a><h2>Appendices</h2><h3 id="appendix-docinfo">Appendix A: Document Information<a class="anchor-link" href="#appendix-docinfo"><abbr title="Link to this point in the document">¶</abbr></a></h3><dl class="compact"><dt>Series</dt><dd><a href="http://xmpp.org/extensions/">XEP</a></dd><dt>Number</dt><dd>0289</dd><dt>Publisher</dt><dd><a href="/xsf/">XMPP Standards Foundation</a></dd><dt>Status</dt><dd><a href="http://xmpp.org/extensions/xep-0001.html#states-Deferred">Deferred</a></dd><dt>Type</dt><dd><a href="http://xmpp.org/extensions/xep-0001.html#types-Standards%20Track">Standards Track</a></dd><dt>Version</dt><dd>0.2.1</dd><dt>Last Updated</dt><dd>2021-03-04</dd><dt>Approving Body</dt><dd><a href="http://xmpp.org/council/">XMPP Council</a></dd><dt>Dependencies</dt><dd>XMPP Core, XEP-0045</dd><dt>Supersedes</dt><dd>XEP-0281</dd><dt>Superseded By</dt><dd>None</dd><dt>Short Name</dt><dd>FMUC</dd><dt>Source Control</dt><dd><a class="standardsButton" href="https://github.com/xsf/xeps/blob/master/xep-0289.xml">HTML</a></dd></dl><p>
          This document in other formats:
          <a class="standardsButton" href="http://xmpp.org/extensions/xep-0289.xml">XML</a> 
          <a class="standardsButton" href="http://xmpp.org/extensions/xep-0289.pdf">PDF</a></p><h3 id="appendix-authorinfo">Appendix B: Author Information<a class="anchor-link" href="#appendix-authorinfo"><abbr title="Link to this point in the document">¶</abbr></a></h3><h5>Kevin Smith</h5><dl class="compact"><dt>Email</dt><dd><a href="mailto:kevin.smith@isode.com">kevin.smith@isode.com</a></dd><dt>JabberID</dt><dd><a href="xmpp:kevin.smith@isode.com">kevin.smith@isode.com</a></dd></dl><h3 id="appendix-legal">Appendix C: Legal Notices<a class="anchor-link" href="#appendix-legal"><abbr title="Link to this point in the document">¶</abbr></a></h3><div class="indent"><h4>Copyright</h4><p>This XMPP Extension Protocol is copyright © 1999 – 2020 by the <a href="https://xmpp.org/">XMPP Standards Foundation</a> (XSF).</p><h4>Permissions</h4><p>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.</p><h4>Disclaimer of Warranty</h4><p class="box info">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. ##</p><h4>Limitation of Liability</h4><p>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.</p><h4>IPR Conformance</h4><p>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which can be found at &lt;<a href="https://xmpp.org/about/xsf/ipr-policy">https://xmpp.org/about/xsf/ipr-policy</a>&gt; or obtained by writing to XMPP Standards Foundation, P.O. Box 787, Parker, CO 80134 USA).</p><h4>Visual Presentation</h4><p>The HTML representation (you are looking at) is maintained by the XSF. It is based on the <a href="http://yaml.de">YAML CSS Framework</a>, which is licensed under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/">CC-BY-SA 2.0</a> license.</p></div><h3 id="appendix-xmpp">Appendix D: Relation to XMPP<a class="anchor-link" href="#appendix-xmpp"><abbr title="Link to this point in the document">¶</abbr></a></h3><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 6120) and XMPP IM (RFC 6121) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h3 id="appendix-discuss">Appendix E: Discussion Venue<a class="anchor-link" href="#appendix-discuss"><abbr title="Link to this point in the document">¶</abbr></a></h3><p class="indent">The primary venue for discussion of XMPP Extension Protocols is the &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">standards@xmpp.org</a>&gt; discussion list.</p><p class="indent">Discussion on other xmpp.org discussion lists might also be appropriate; see &lt;<a href="http://xmpp.org/about/discuss.shtml">http://xmpp.org/about/discuss.shtml</a>&gt; for a complete list.</p><p class="indent">Errata can be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h3 id="appendix-conformance">Appendix F: Requirements Conformance<a class="anchor-link" href="#appendix-conformance"><abbr title="Link to this point in the document">¶</abbr></a></h3><p class="indent">The following requirements keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><h3 id="appendix-notes">Appendix G: Notes<a class="anchor-link" href="#appendix-notes"><abbr title="Link to this point in the document">¶</abbr></a></h3><div class="indent"><p><a name="nt-idm79">1</a>. XEP-0106: JID Escaping &lt;<a href="https://xmpp.org/extensions/xep-0106.html">https://xmpp.org/extensions/xep-0106.html</a>&gt;.</p></div><h3 id="appendix-revs">Appendix H: Revision History<a class="anchor-link" href="#appendix-revs"><abbr title="Link to this point in the document">¶</abbr></a></h3><p>Note: Older versions of this specification might be available at <a href="http://xmpp.org/extensions/attic/">http://xmpp.org/extensions/attic/</a></p><ol class="revision-history"><li id="revision-history-v0.2.1"><div class="revision-head">Version 0.2.1 (2021-03-04)<a class="anchor-link" href="#revision-history-v0.2.1"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">Cross-document editorial adjustments for inclusive language.</p><div class="revision-author">mw</div></li><li id="revision-history-v0.2"><div class="revision-head">Version 0.2 (2012-05-29)<a class="anchor-link" href="#revision-history-v0.2"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">Reworking for new protocol and clarity of purpose.</p><div class="revision-author">kis</div></li><li id="revision-history-v0.1"><div class="revision-head">Version 0.1 (2010-11-29)<a class="anchor-link" href="#revision-history-v0.1"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">Initial published version.</p><div class="revision-author">psa</div></li><li id="revision-history-v0.0.1"><div class="revision-head">Version 0.0.1 (2010-05-24)<a class="anchor-link" href="#revision-history-v0.0.1"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">First draft.</p><div class="revision-author">kis</div></li></ol><p>END</p></body></html>
